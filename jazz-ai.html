<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JAZZ - AI Practice Partner | improvU</title>
    <meta name="description" content="Practice conversations with your AI coach in a safe, judgment-free environment. Master improvisational skills through real-time feedback.">
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Google Generative AI Import Map -->
    <script type="importmap">
    {
        "imports": {
            "@google/generative-ai": "https://cdn.jsdelivr.net/npm/@google/generative-ai@latest/dist/index.mjs"
        }
    }
    </script>
    
    <style>
        /* ============================================
           LAYOUT OVERRIDES - Full height chat with pinned input
           Using !important to override external styles.css
           ============================================ */
        .jazz-main {
            padding-top: 100px !important;
            min-height: 100vh !important;
            background: linear-gradient(135deg, #F8F9FB 0%, #EEF1F8 100%) !important;
        }
        .jazz-layout {
            height: calc(100vh - 140px) !important;
            display: grid !important;
        }
        .jazz-chat {
            display: flex !important;
            flex-direction: column !important;
            height: 100% !important;
            max-height: 100% !important;
            min-height: 0 !important;
            overflow: hidden !important;
        }
        .chat-messages {
            flex: 1 1 auto !important;
            min-height: 0 !important;
            max-height: none !important;
            overflow-y: auto !important;
            padding: 24px !important;
            scroll-behavior: smooth !important;
            display: flex !important;
            flex-direction: column !important;
            gap: 16px !important;
        }
        .chat-input-area {
            flex: 0 0 auto !important;
            margin-top: auto !important;
            padding: 20px 24px !important;
            background: white !important;
            border-top: 1px solid #E5E8F0 !important;
            border-radius: 0 0 16px 16px !important;
        }
        /* Hide old voice-input class if it exists */
        .voice-input {
            display: none !important;
        }
        /* Ensure scenario header doesn't grow */
        .scenario-header {
            flex: 0 0 auto !important;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* ============================================
           COUNTDOWN TIMER
           ============================================ */
        .timer-container {
            display: none;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #1E2875 0%, #4169E1 100%);
            border-radius: 100px;
            color: white;
            font-weight: 600;
            font-size: 16px;
        }
        .timer-container.active {
            display: flex;
        }
        .timer-container svg {
            width: 20px;
            height: 20px;
        }
        .timer-display {
            font-family: 'Inter', monospace;
            font-variant-numeric: tabular-nums;
        }
        .timer-progress {
            width: 60px;
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            overflow: hidden;
        }
        .timer-progress-fill {
            height: 100%;
            background: #FFD700;
            border-radius: 3px;
            transition: width 1s linear;
        }
        .timer-container.warning {
            background: linear-gradient(135deg, #DC2626 0%, #EF4444 100%);
            animation: timerPulse 0.5s ease-in-out infinite;
        }
        @keyframes timerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        /* ============================================
           CHAT INPUT STYLING
           ============================================ */
        .chat-input-container {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .chat-input {
            flex: 1;
            padding: 16px 24px;
            border: 2px solid #E5E8F0;
            border-radius: 100px;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            color: #1E2875;
            background: #F8F9FB;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .chat-input:focus {
            outline: none;
            border-color: #4169E1;
            background: #FFFFFF;
            box-shadow: 0 0 0 4px rgba(65, 105, 225, 0.1);
        }
        .chat-input::placeholder {
            color: #9CA3AF;
        }
        .chat-input:disabled {
            background: #F3F4F6;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .send-btn {
            background: linear-gradient(135deg, #4169E1 0%, #5B7FFF 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 100px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 14px rgba(65, 105, 225, 0.35);
        }
        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(65, 105, 225, 0.45);
        }
        .send-btn:disabled {
            background: #CBD5E1;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .send-btn svg {
            width: 18px;
            height: 18px;
        }

        /* ============================================
           MICROPHONE BUTTON
           ============================================ */
        .mic-btn {
            background: #F1F5F9;
            color: #4169E1;
            border: 2px solid #E5E8F0;
            padding: 14px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .mic-btn:hover:not(:disabled) {
            background: #E0E7FF;
            border-color: #4169E1;
            transform: translateY(-2px);
        }
        .mic-btn.recording {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            color: white;
            border-color: #EF4444;
            animation: micPulse 1.5s ease-in-out infinite;
            box-shadow: 0 4px 14px rgba(239, 68, 68, 0.4);
        }
        .mic-btn:disabled {
            background: #F3F4F6;
            color: #9CA3AF;
            border-color: #E5E8F0;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .mic-btn svg {
            width: 20px;
            height: 20px;
        }
        @keyframes micPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }

        .input-hint {
            text-align: center;
            font-size: 13px;
            color: #9CA3AF;
            margin-top: 10px;
        }
        .input-hint .keyboard-hint {
            color: #6B7280;
            font-weight: 500;
        }

        /* ============================================
           MESSAGE STYLING
           ============================================ */
        .ai-avatar {
            width: 36px;
            height: 36px;
            min-width: 36px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #1E2875;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 15px;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
        }
        .message.ai-message .message-content {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            background: linear-gradient(135deg, #4169E1 0%, #5B7FFF 100%);
            color: white;
            padding: 16px 20px;
            border-radius: 20px 20px 20px 4px;
            box-shadow: 0 4px 12px rgba(65, 105, 225, 0.2);
        }
        .message.ai-message .ai-text {
            flex: 1;
            white-space: pre-wrap;
            line-height: 1.6;
        }
        .message.user-message .message-content {
            background: #F1F5F9;
            color: #1E2875;
            padding: 16px 20px;
            border-radius: 20px 20px 4px 20px;
        }
        
        /* Yes And Badge - user messages need column layout for badge below */
        .message.user-message {
            position: relative;
            flex-direction: column !important;
            align-items: flex-end !important;
        }
        .yes-and-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 5px 12px;
            border-radius: 12px;
            margin-top: 8px;
            animation: badgePop 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }
        .blocking-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 5px 12px;
            border-radius: 12px;
            margin-top: 8px;
            animation: badgePop 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }
        @keyframes badgePop {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* Error message styling */
        .message.error-message .message-content {
            background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%) !important;
            color: #991B1B !important;
        }
        .message.error-message .ai-avatar {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            color: white;
        }
        
        /* Typing indicator */
        .message.ai-message.typing .message-content {
            padding: 16px 20px;
        }
        .message.ai-message .typing-indicator {
            display: flex;
            gap: 6px;
            align-items: center;
            padding: 4px 0;
        }
        .message.ai-message .typing-indicator span {
            width: 10px;
            height: 10px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        .message.ai-message .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .message.ai-message .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* ============================================
           SIDEBAR ENHANCEMENTS
           ============================================ */
        .jazz-sidebar {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(30, 40, 117, 0.08);
        }
        .how-to-play-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 14px 20px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #1E2875;
            border: none;
            border-radius: 14px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
        }
        .how-to-play-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 215, 0, 0.4);
        }
        .how-to-play-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Session Status Indicator */
        .session-status {
            padding: 16px;
            background: linear-gradient(135deg, #F8FAFC 0%, #EEF2FF 100%);
            border-radius: 14px;
            margin-bottom: 20px;
        }
        .status-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #6B7280;
            margin-bottom: 8px;
        }
        .status-value {
            font-size: 16px;
            font-weight: 700;
            color: #1E2875;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #10B981;
            animation: statusPulse 2s infinite;
        }
        .status-dot.teaching { background: #4169E1; }
        .status-dot.playing { background: #10B981; }
        .status-dot.feedback { background: #FFD700; }
        @keyframes statusPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Goal Display */
        .goal-display {
            padding: 16px;
            background: linear-gradient(135deg, #EEF2FF 0%, #E0E7FF 100%);
            border: 2px solid #4169E1;
            border-radius: 14px;
            margin-bottom: 20px;
        }
        .goal-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #4169E1;
            margin-bottom: 6px;
        }
        .goal-value {
            font-size: 15px;
            font-weight: 600;
            color: #1E2875;
        }

        /* ============================================
           FEEDBACK PANEL
           ============================================ */
        .jazz-feedback {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(30, 40, 117, 0.08);
        }
        .jazz-feedback h3 {
            font-size: 18px;
            background: linear-gradient(135deg, #1E2875 0%, #4169E1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .metric-label {
            font-size: 11px;
            color: #9CA3AF;
            margin-top: 6px;
        }
        .progress-fill {
            background: linear-gradient(90deg, #4169E1, #10B981) !important;
        }
        .progress-fill.warning {
            background: linear-gradient(90deg, #F59E0B, #EF4444) !important;
        }

        /* AI Feedback Section */
        .ai-feedback-section {
            margin-top: 20px;
            padding: 16px;
            background: linear-gradient(135deg, #F0FDF4 0%, #DCFCE7 100%);
            border-radius: 14px;
            display: none;
        }
        .ai-feedback-section.visible {
            display: block;
            animation: fadeSlideIn 0.4s ease;
        }
        @keyframes fadeSlideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .ai-feedback-title {
            font-size: 14px;
            font-weight: 700;
            color: #065F46;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .ai-feedback-content {
            font-size: 13px;
            color: #374151;
            line-height: 1.6;
        }

        /* ============================================
           GOAL SELECTION MODAL
           ============================================ */
        .goal-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(30, 40, 117, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
        }
        .goal-modal.hidden { display: none; }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .goal-content {
            background: white;
            border-radius: 28px;
            padding: 48px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 32px 64px rgba(30, 40, 117, 0.4);
            animation: slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes slideUp {
            from { transform: translateY(30px) scale(0.95); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        .goal-header {
            text-align: center;
            margin-bottom: 32px;
        }
        .goal-header .ai-avatar {
            width: 72px;
            height: 72px;
            font-size: 32px;
            margin: 0 auto 20px;
        }
        .goal-header h2 {
            color: #1E2875;
            font-size: 28px;
            margin: 0 0 8px;
            font-weight: 700;
        }
        .goal-header p {
            color: #6B7280;
            font-size: 15px;
            margin: 0;
        }
        
        .goal-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }
        .goal-option {
            padding: 16px 20px;
            border: 2px solid #E5E8F0;
            border-radius: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }
        .goal-option:hover {
            border-color: #4169E1;
            background: #F8FAFC;
        }
        .goal-option.selected {
            border-color: #4169E1;
            background: linear-gradient(135deg, #EEF2FF 0%, #E0E7FF 100%);
        }
        .goal-option h4 {
            margin: 0 0 4px;
            font-size: 15px;
            font-weight: 600;
            color: #1E2875;
        }
        .goal-option p {
            margin: 0;
            font-size: 13px;
            color: #6B7280;
        }

        .custom-goal-section {
            margin-bottom: 24px;
        }
        .custom-goal-label {
            font-size: 14px;
            font-weight: 600;
            color: #1E2875;
            margin-bottom: 8px;
            display: block;
        }
        .custom-goal-input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #E5E8F0;
            border-radius: 12px;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            color: #1E2875;
            transition: all 0.2s ease;
        }
        .custom-goal-input:focus {
            outline: none;
            border-color: #4169E1;
            box-shadow: 0 0 0 4px rgba(65, 105, 225, 0.1);
        }
        .custom-goal-input::placeholder {
            color: #9CA3AF;
        }

        .goal-submit-btn {
            display: block;
            width: 100%;
            background: linear-gradient(135deg, #4169E1 0%, #5B7FFF 100%);
            color: white;
            font-size: 17px;
            font-weight: 600;
            padding: 18px 36px;
            border-radius: 100px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(65, 105, 225, 0.35);
        }
        .goal-submit-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 28px rgba(65, 105, 225, 0.45);
        }
        .goal-submit-btn:disabled {
            background: #CBD5E1;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* ============================================
           RESPONSIVE
           ============================================ */
        @media (max-width: 768px) {
            .goal-options { grid-template-columns: 1fr; }
            .goal-content { padding: 28px; }
            .goal-header h2 { font-size: 24px; }
        }
    </style>
</head>
<body>
    <!-- ============================================
         GOAL SELECTION MODAL
         ============================================ -->
    <div class="goal-modal" id="goalModal">
        <div class="goal-content">
            <div class="goal-header">
                <div class="ai-avatar">J</div>
                <h2>Welcome to Jazz</h2>
                <p>What would you like to practice today?</p>
            </div>
            
            <div class="goal-options" id="goalOptions">
                <div class="goal-option" data-goal="Networking Event">
                    <h4>Networking Event</h4>
                    <p>Professional mingling</p>
                </div>
                <div class="goal-option" data-goal="Job Interview">
                    <h4>Job Interview</h4>
                    <p>Build confidence</p>
                </div>
                <div class="goal-option" data-goal="Asking for a Promotion">
                    <h4>Asking for a Promotion</h4>
                    <p>Workplace conversations</p>
                </div>
                <div class="goal-option" data-goal="Approaching Someone for a Date">
                    <h4>Asking Someone Out</h4>
                    <p>Dating confidence</p>
                </div>
                <div class="goal-option" data-goal="Coffee Shop Conversation">
                    <h4>Coffee Shop Chat</h4>
                    <p>Casual small talk</p>
                </div>
                <div class="goal-option" data-goal="Team Meeting">
                    <h4>Team Meeting</h4>
                    <p>Group discussions</p>
                </div>
            </div>
            
            <div class="custom-goal-section">
                <label class="custom-goal-label">Or enter your own scenario:</label>
                <input type="text" class="custom-goal-input" id="customGoalInput" placeholder="e.g., Negotiating a raise, Making new friends...">
            </div>
            
            <button class="goal-submit-btn" id="goalSubmitBtn" disabled>
                Start Learning
            </button>
        </div>
    </div>

    <!-- ============================================
         NAVIGATION (no icon, just text)
         ============================================ -->
    <nav class="nav">
        <div class="container">
            <div class="nav-content">
                <div class="logo">
                    <a href="index.html" class="logo-text">improvU</a>
                </div>
                <div class="nav-links">
                    <a href="jazz-ai.html" class="nav-link active">Jazz</a>
                    <a href="convoquest.html" class="nav-link">ConvoQuest</a>
                    <a href="improvcircle.html" class="nav-link">ImprovCircle</a>
                    <button class="nav-login-btn">Get Started</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- ============================================
         JAZZ MAIN CONTENT
         ============================================ -->
    <section class="jazz-main">
        <div class="container">
            <div class="jazz-layout">
                <!-- Left Sidebar -->
                <div class="jazz-sidebar">
                    <div class="jazz-header">
                        <h1 class="jazz-title">Jazz AI</h1>
                        <button class="new-session-btn" id="newSessionBtn">
                            <svg viewBox="0 0 24 24" fill="none">
                                <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            New
                        </button>
                    </div>

                    <!-- Session Status -->
                    <div class="session-status">
                        <div class="status-label">Current Phase</div>
                        <div class="status-value">
                            <span class="status-dot teaching" id="statusDot"></span>
                            <span id="statusText">Waiting...</span>
                        </div>
                    </div>

                    <!-- Goal Display (hidden until goal selected) -->
                    <div class="goal-display" id="goalDisplay" style="display: none;">
                        <div class="goal-label">Your Goal</div>
                        <div class="goal-value" id="goalValueText">--</div>
                    </div>

                    <!-- How to Play Button -->
                    <button class="how-to-play-btn" id="howToPlayBtn">
                        <svg viewBox="0 0 24 24" fill="none">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                            <path d="M12 16v-4M12 8h.01" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
                        </svg>
                        Restart Tutorial
                    </button>

                    <div class="user-profile">
                        <div class="user-avatar">U</div>
                        <div class="user-info">
                            <h4>Guest User</h4>
                            <p>Practice Mode</p>
                        </div>
                    </div>
                </div>

                <!-- Main Chat Area -->
                <div class="jazz-chat">
                    <div class="scenario-header">
                        <span class="scenario-badge" id="scenarioBadge">Learning "Yes, and..."</span>
                        <!-- Timer (hidden until playing) -->
                        <div class="timer-container" id="timerContainer">
                            <svg viewBox="0 0 24 24" fill="none">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            <span class="timer-display" id="timerDisplay">1:30</span>
                            <div class="timer-progress">
                                <div class="timer-progress-fill" id="timerProgressFill" style="width: 100%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="chat-messages" id="chatMessages">
                        <!-- Messages inserted by JS -->
                    </div>

                    <!-- Text Input Area - PINNED TO BOTTOM -->
                    <div class="chat-input-area">
                        <div class="chat-input-container">
                            <input 
                                type="text" 
                                class="chat-input" 
                                id="chatInput" 
                                placeholder="Type your response here..." 
                                autocomplete="off"
                            >
                            <button class="mic-btn" id="micBtn" title="Click to speak" aria-label="Voice input">
                                <svg viewBox="0 0 24 24" fill="none">
                                    <path d="M12 1a4 4 0 0 0-4 4v7a4 4 0 0 0 8 0V5a4 4 0 0 0-4-4z" stroke="currentColor" stroke-width="2"/>
                                    <path d="M19 10v2a7 7 0 0 1-14 0v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    <path d="M12 19v4M8 23h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </button>
                            <button class="send-btn" id="sendBtn">
                                <svg viewBox="0 0 24 24" fill="none">
                                    <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Send
                            </button>
                        </div>
                        <p class="input-hint" id="inputPrompt">
                            Type your response <span class="keyboard-hint">(Enter to send)</span>
                        </p>
                    </div>
                </div>

                <!-- Right Sidebar - Feedback -->
                <div class="jazz-feedback">
                    <h3>Session Feedback</h3>
                    
                    <div class="feedback-metric">
                        <div class="metric-header">
                            <span>"Yes, And" Count</span>
                            <span class="metric-value" id="yesAndValue">0</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="yesAndFill" style="width: 0%"></div>
                        </div>
                        <p class="metric-label">Times you accepted and built on ideas</p>
                    </div>

                    <div class="feedback-metric">
                        <div class="metric-header">
                            <span>Blocking Count</span>
                            <span class="metric-value" id="blockingValue">0</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill warning" id="blockingFill" style="width: 0%"></div>
                        </div>
                        <p class="metric-label">Times you rejected or shut down ideas</p>
                    </div>

                    <div class="feedback-metric">
                        <div class="metric-header">
                            <span>Engagement</span>
                            <span class="metric-value" id="engagementValue">--</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="engagementFill" style="width: 0%"></div>
                        </div>
                        <p class="metric-label">Response quality and flow</p>
                    </div>

                    <div class="session-settings">
                        <h4>Session Info</h4>
                        <div class="setting-item">
                            <span>Model</span>
                            <span class="setting-value">Gemini 2.5 Flash</span>
                        </div>
                        <div class="setting-item">
                            <span>Mode</span>
                            <span class="setting-value">Streaming</span>
                        </div>
                        <div class="setting-item">
                            <span>Messages</span>
                            <span class="setting-value" id="messageCount">0</span>
                        </div>
                    </div>

                    <!-- AI Feedback Section (shown after session) -->
                    <div class="ai-feedback-section" id="aiFeedbackSection">
                        <div class="ai-feedback-title">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            Improvement Tips
                        </div>
                        <div class="ai-feedback-content" id="aiFeedbackContent">
                            <!-- AI-generated feedback appears here -->
                        </div>
                    </div>

                    <button class="end-session-btn" id="endSessionBtn">End Session Early</button>
                </div>
            </div>
        </div>
    </section>

    <!-- ============================================
         MAIN APPLICATION SCRIPT
         ============================================ -->
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // ============================================
        // CONFIGURATION
        // ============================================
        
        async function getApiKey() {
            if (typeof window !== 'undefined' && window.GEMINI_API_KEY) {
                return window.GEMINI_API_KEY;
            }
            const storedKey = localStorage.getItem('gemini_api_key');
            if (storedKey) return storedKey;
            
            const key = prompt(
                'Enter your Gemini API key:\n\n' +
                'Get a free key at:\nhttps://makersuite.google.com/app/apikey\n\n' +
                '(Key will be saved for convenience)'
            );
            if (key && key.trim()) {
                localStorage.setItem('gemini_api_key', key.trim());
                return key.trim();
            }
            return null;
        }

        // ============================================
        // SYSTEM PROMPT - Multi-mode AI Instruction
        // ============================================
        
        function getSystemInstruction(userGoal) {
            return `You are JAZZ, an encouraging and playful improv coach from a web app called improvU.

IMPORTANT RULES (Apply in all modes):
- You MUST NOT use any emojis.
- All your responses MUST be short and concise, so the user can read and quickly respond. Particularly during "yes and..." practice sessions.
- When creating a list, you MUST use the round bullet character (•). Do NOT use asterisks (*) or hyphens (-). For example: • This is a correct list item.

MODES OF OPERATION:

1. TEACHING MODE:
Your initial goal is to teach the user the 'Yes, and...' concept. You will stay in this mode until the user agrees to start a practice session.

Teaching Flow:
1. When you receive "[User has joined the session]" or any initial greeting, your very first response must be a short welcome of 2-3 sentences. Introduce yourself as JAZZ from improvU and ask the user if they're ready to learn about the 'Yes, and...' concept.
2. After the user confirms, explain the objective of 'Yes, and...' using a bulleted list. End this message with a question to check for understanding (e.g., "Does that make sense?").
3. Next, explain the rules of how to play using a bulleted list. Add a section at the bottom to explain the user does not have to start with "Yes and..."; it's a foundational guideline, but you can accept a response with other affirmative phrases like "Okay," "Sure," "Right," or even rephrasing with questions like "Cool, and then what?" to keep the scene moving, with the key being acceptance and addition, not just those exact words. End with a question to see if they have any questions.
4. Patiently answer any questions. Always end your clarifications with a question to ensure they've understood.
5. Once you are confident the user understands, you MUST ask them if they would like to start a practice session.

2. TOPIC SELECTION MODE:
This mode is triggered when the user agrees to start a practice session.
Your only response in this mode MUST be similar to: "Great! To get started, I will set up a scene based on your goal: ${userGoal}. Ready to begin?" Do not add any other text or formatting.

3. PLAYING MODE:
This mode is triggered after the user confirms they are ready to begin. When the user says something like "yes", "ready", "let's go", "start", etc. after the topic selection message, enter this mode.

Playing Flow:
1. Upon entering this mode, your first message MUST be a creative and unique starting prompt for an improv scene related to the goal: ${userGoal}. You start the scene and assume the role of the other party in the scenario. Keep it to 2-3 sentences maximum.
2. After you provide the starting prompt, ALL your subsequent responses in this mode MUST begin with the exact phrase "Yes, and...".
3. In this mode, you MUST NOT ask questions at the end of your turn. Commit to the scene and just add the next piece of information. Your goal is to be a fun and creative improv partner.
4. Keep all responses to 2-3 sentences maximum.

USER'S GOAL: ${userGoal}`;
        }

        // ============================================
        // DOM ELEMENTS
        // ============================================
        
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const micBtn = document.getElementById('micBtn');
        const inputPrompt = document.getElementById('inputPrompt');
        const scenarioBadge = document.getElementById('scenarioBadge');
        const newSessionBtn = document.getElementById('newSessionBtn');
        const endSessionBtn = document.getElementById('endSessionBtn');
        const howToPlayBtn = document.getElementById('howToPlayBtn');
        
        // Goal Modal Elements
        const goalModal = document.getElementById('goalModal');
        const goalOptions = document.getElementById('goalOptions');
        const customGoalInput = document.getElementById('customGoalInput');
        const goalSubmitBtn = document.getElementById('goalSubmitBtn');
        
        // Sidebar Elements
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const goalDisplay = document.getElementById('goalDisplay');
        const goalValueText = document.getElementById('goalValueText');
        
        // Timer Elements
        const timerContainer = document.getElementById('timerContainer');
        const timerDisplay = document.getElementById('timerDisplay');
        const timerProgressFill = document.getElementById('timerProgressFill');
        
        // Feedback Elements
        const yesAndValue = document.getElementById('yesAndValue');
        const yesAndFill = document.getElementById('yesAndFill');
        const blockingValue = document.getElementById('blockingValue');
        const blockingFill = document.getElementById('blockingFill');
        const engagementValue = document.getElementById('engagementValue');
        const engagementFill = document.getElementById('engagementFill');
        const messageCountEl = document.getElementById('messageCount');
        const aiFeedbackSection = document.getElementById('aiFeedbackSection');
        const aiFeedbackContent = document.getElementById('aiFeedbackContent');

        // ============================================
        // STATE
        // ============================================
        
        // App States: 'GOAL_SELECTION' | 'TEACHING' | 'TOPIC_SELECTION' | 'PLAYING' | 'FEEDBACK'
        let currentState = 'GOAL_SELECTION';
        let genAI = null;
        let chat = null;
        let userGoal = null;
        let isGenerating = false;
        
        // Metrics
        let messageCount = 0;
        let yesAndCount = 0;
        let blockingCount = 0;
        let userMessageCount = 0;
        let lastMessageTime = Date.now();
        let totalResponseTime = 0;
        
        // Timer
        let timerInterval = null;
        let timeRemaining = 90; // seconds
        const TOTAL_TIME = 90;
        let timerStarted = false; // Track if timer has been started this session

        // ============================================
        // SPEECH RECOGNITION
        // ============================================
        
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isRecording = false;
        let recognitionCooldown = false;
        let permissionGranted = false;
        const originalPlaceholder = chatInput.placeholder;
        
        // Check permission status using Permissions API
        if (navigator.permissions) {
            navigator.permissions.query({ name: 'microphone' }).then(result => {
                permissionGranted = (result.state === 'granted');
                result.onchange = () => {
                    permissionGranted = (result.state === 'granted');
                };
            }).catch(() => {
                // Permissions API not fully supported, will rely on recognition errors
            });
        }
        
        // Check for browser support
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            
            recognition.onstart = () => {
                // Permission was granted if we got here
                permissionGranted = true;
            };
            
            recognition.onresult = (event) => {
                const transcript = Array.from(event.results)
                    .map(result => result[0].transcript)
                    .join('');
                chatInput.value = transcript;
            };
            
            recognition.onend = () => {
                // Only update UI, don't call stop() again
                isRecording = false;
                micBtn.classList.remove('recording');
                chatInput.placeholder = originalPlaceholder;
                
                // Add cooldown to prevent rapid restart issues
                recognitionCooldown = true;
                setTimeout(() => { recognitionCooldown = false; }, 300);
            };
            
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                
                // Reset state
                isRecording = false;
                micBtn.classList.remove('recording');
                chatInput.placeholder = originalPlaceholder;
                
                if (event.error === 'not-allowed') {
                    permissionGranted = false;
                    alert('Microphone access was denied. Please allow microphone access in your browser settings and refresh the page.');
                } else if (event.error === 'aborted') {
                    // User or system aborted, just reset silently
                } else if (event.error === 'no-speech') {
                    // No speech detected, reset silently
                }
                
                // Add cooldown after error
                recognitionCooldown = true;
                setTimeout(() => { recognitionCooldown = false; }, 500);
            };
        } else {
            // Browser doesn't support speech recognition
            micBtn.disabled = true;
            micBtn.title = 'Speech recognition not supported in this browser. Try Chrome or Edge.';
        }
        
        function startRecording() {
            if (!recognition || isRecording || chatInput.disabled || recognitionCooldown) return;
            
            try {
                recognition.start();
                isRecording = true;
                micBtn.classList.add('recording');
                chatInput.placeholder = 'Listening...';
                chatInput.focus();
            } catch (error) {
                console.error('Failed to start recording:', error);
                // Reset state if start fails
                isRecording = false;
                micBtn.classList.remove('recording');
                chatInput.placeholder = originalPlaceholder;
            }
        }
        
        function stopRecording() {
            if (!isRecording) return;
            
            try {
                recognition.abort(); // Use abort() instead of stop() to immediately halt
            } catch (error) {
                // Already stopped
            }
            // Note: onend handler will reset the UI state
        }
        
        micBtn.addEventListener('click', () => {
            if (!recognition) {
                alert('Speech recognition is not supported in this browser. Please use Chrome or Edge.');
                return;
            }
            
            if (chatInput.disabled || recognitionCooldown) return;
            
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        });

        // ============================================
        // GOAL SELECTION
        // ============================================
        
        let selectedGoal = null;
        
        goalOptions.querySelectorAll('.goal-option').forEach(option => {
            option.addEventListener('click', () => {
                goalOptions.querySelectorAll('.goal-option').forEach(o => o.classList.remove('selected'));
                option.classList.add('selected');
                selectedGoal = option.dataset.goal;
                customGoalInput.value = '';
                updateGoalSubmitButton();
            });
        });
        
        customGoalInput.addEventListener('input', () => {
            if (customGoalInput.value.trim()) {
                goalOptions.querySelectorAll('.goal-option').forEach(o => o.classList.remove('selected'));
                selectedGoal = customGoalInput.value.trim();
            } else {
                selectedGoal = null;
            }
            updateGoalSubmitButton();
        });
        
        function updateGoalSubmitButton() {
            goalSubmitBtn.disabled = !selectedGoal;
        }
        
        goalSubmitBtn.addEventListener('click', async () => {
            if (!selectedGoal) return;
            
            userGoal = selectedGoal;
            goalModal.classList.add('hidden');
            
            // Show goal in sidebar
            goalDisplay.style.display = 'block';
            goalValueText.textContent = userGoal;
            
            // Initialize and start teaching
            await initializeAI();
        });

        // ============================================
        // INITIALIZATION
        // ============================================
        
        async function initializeAI() {
            updateState('TEACHING');
            chatInput.placeholder = "Connecting to Jazz AI...";
            
            const API_KEY = await getApiKey();
            if (!API_KEY) {
                chatInput.placeholder = "API key required";
                showError("API key not configured. Please refresh and enter your key.");
                return;
            }
            
            try {
                genAI = new GoogleGenerativeAI(API_KEY);
                console.log('Gemini AI initialized');
                chatInput.placeholder = "Type your response here...";
                
                await startChat();
            } catch (error) {
                console.error('Failed to initialize:', error);
                showError("Failed to connect. Please check your API key.");
            }
        }
        
        async function startChat() {
            try {
                const model = genAI.getGenerativeModel({ 
                    model: "gemini-2.5-flash",
                    systemInstruction: getSystemInstruction(userGoal)
                });
                
                chat = model.startChat({
                    history: [],
                    generationConfig: {
                        maxOutputTokens: 500,
                        temperature: 0.8,
                    },
                });
                
                // AI sends first welcome message (neutral trigger that doesn't skip teaching flow)
                await sendToAI("[User has joined the session]");
            } catch (error) {
                console.error('Chat init failed:', error);
                showError("Connection issue. Please try again.");
            }
        }

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        
        function updateState(newState) {
            currentState = newState;
            
            // Update status indicator
            statusDot.className = 'status-dot';
            switch (newState) {
                case 'GOAL_SELECTION':
                    statusText.textContent = 'Select a Goal';
                    break;
                case 'TEACHING':
                    statusDot.classList.add('teaching');
                    statusText.textContent = 'Learning';
                    scenarioBadge.textContent = 'Learning "Yes, and..."';
                    break;
                case 'TOPIC_SELECTION':
                    statusDot.classList.add('teaching');
                    statusText.textContent = 'Ready to Practice';
                    scenarioBadge.textContent = 'Starting Practice';
                    break;
                case 'PLAYING':
                    statusDot.classList.add('playing');
                    statusText.textContent = 'Playing';
                    scenarioBadge.textContent = `Practicing: ${userGoal}`;
                    // Timer starts after AI sends first scene message, not here
                    break;
                case 'FEEDBACK':
                    statusDot.classList.add('feedback');
                    statusText.textContent = 'Session Complete';
                    scenarioBadge.textContent = 'Session Feedback';
                    stopTimer();
                    generateFeedback();
                    break;
            }
        }
        
        // Detect state transitions from AI responses
        function detectStateTransition(aiResponse) {
            const lowerResponse = aiResponse.toLowerCase();
            
            if (currentState === 'TEACHING') {
                // Check if AI is asking to start practice
                if (lowerResponse.includes('ready to begin') || 
                    lowerResponse.includes('start a practice') ||
                    lowerResponse.includes('would you like to start') ||
                    lowerResponse.includes('want to start') ||
                    lowerResponse.includes('shall we start') ||
                    lowerResponse.includes('set up a scene')) {
                    updateState('TOPIC_SELECTION');
                }
            }
        }
        
        // Detect user intent to start playing
        function detectUserReadyToPlay(userMessage) {
            if (currentState !== 'TOPIC_SELECTION') return false;
            
            const lowerMessage = userMessage.toLowerCase();
            const readyPhrases = ['yes', 'ready', 'let\'s go', 'start', 'begin', 'sure', 'okay', 'ok', 'yep', 'yeah', 'absolutely', 'let\'s do it', 'i\'m ready'];
            
            return readyPhrases.some(phrase => lowerMessage.includes(phrase));
        }

        // ============================================
        // TIMER
        // ============================================
        
        function startTimer() {
            timeRemaining = TOTAL_TIME;
            timerContainer.classList.add('active');
            timerContainer.classList.remove('warning');
            updateTimerDisplay();
            
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                // Warning state when 15 seconds left
                if (timeRemaining <= 15) {
                    timerContainer.classList.add('warning');
                }
                
                if (timeRemaining <= 0) {
                    updateState('FEEDBACK');
                }
            }, 1000);
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            timerContainer.classList.remove('active');
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            const progressPercent = (timeRemaining / TOTAL_TIME) * 100;
            timerProgressFill.style.width = progressPercent + '%';
        }

        // ============================================
        // CHAT FUNCTIONALITY
        // ============================================
        
        sendBtn.addEventListener('click', handleSend);
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        });

        async function handleSend() {
            const message = chatInput.value.trim();
            if (!message || isGenerating || !chat) return;
            
            // Track response time
            const responseTime = Date.now() - lastMessageTime;
            totalResponseTime += responseTime;
            
            // Check if user is ready to play (state transition)
            if (detectUserReadyToPlay(message)) {
                updateState('PLAYING');
            }
            
            addUserMessage(message);
            chatInput.value = '';
            
            await sendToAI(message);
            lastMessageTime = Date.now();
        }

        async function sendToAI(userMessage) {
            if (isGenerating) return;
            
            isGenerating = true;
            sendBtn.disabled = true;
            chatInput.disabled = true;
            micBtn.disabled = true;
            if (isRecording) stopRecording();
            
            const typingDiv = showTypingIndicator();
            
            try {
                const result = await chat.sendMessageStream(userMessage);
                typingDiv.remove();
                const aiMessageDiv = createAIMessageElement();
                const textSpan = aiMessageDiv.querySelector('.ai-text');
                
                let fullResponse = '';
                for await (const chunk of result.stream) {
                    fullResponse += chunk.text();
                    textSpan.textContent = fullResponse;
                    scrollToBottom();
                }
                
                // Detect state transitions from AI response
                detectStateTransition(fullResponse);
                
                // Start timer when AI sends first scene message in PLAYING mode
                if (currentState === 'PLAYING' && !timerStarted) {
                    timerStarted = true;
                    startTimer();
                }
                
                updateMetrics();
            } catch (error) {
                console.error('AI error:', error);
                typingDiv.remove();
                showError("Connection issue. Please try again.");
            } finally {
                isGenerating = false;
                sendBtn.disabled = false;
                chatInput.disabled = false;
                if (recognition) micBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ============================================
        // PATTERN DETECTION
        // ============================================
        
        function hasYesAndPattern(text) {
            const patterns = [
                /yes,?\s+and/i, /absolutely/i, /great idea/i, /love that/i, 
                /that sounds/i, /building on/i, /i like that/i, /perfect/i, 
                /definitely/i, /what if we/i, /we could also/i, /let's also/i, 
                /and we/i, /and maybe/i, /sure,?\s+and/i, /okay,?\s+and/i,
                /right,?\s+and/i, /cool,?\s+and/i, /that's great/i
            ];
            return patterns.some(p => p.test(text));
        }
        
        function hasBlockingPattern(text) {
            const patterns = [
                /\bno\b/i, /\bcan't\b/i, /\bcannot\b/i, /\bwon't\b/i, 
                /that won't work/i, /that's impossible/i, /that doesn't make sense/i,
                /i don't think/i, /that's not/i, /we shouldn't/i, /bad idea/i,
                /that's wrong/i, /never/i, /impossible/i
            ];
            return patterns.some(p => p.test(text));
        }

        // ============================================
        // MESSAGES
        // ============================================
        
        function addUserMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user-message';
            
            let badge = '';
            if (currentState === 'PLAYING') {
                const usedYesAnd = hasYesAndPattern(text);
                const usedBlocking = hasBlockingPattern(text) && !usedYesAnd;
                
                if (usedYesAnd) {
                    yesAndCount++;
                    badge = '<span class="yes-and-badge">Nice "Yes, and..."!</span>';
                } else if (usedBlocking) {
                    blockingCount++;
                    badge = '<span class="blocking-badge">Try accepting the idea!</span>';
                }
                userMessageCount++;
            }
            
            messageDiv.innerHTML = `
                <div class="message-content">${escapeHtml(text)}</div>
                ${badge}
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
            messageCount++;
            updateMessageCount();
        }

        function createAIMessageElement() {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai-message';
            messageDiv.innerHTML = `
                <div class="message-content">
                    <div class="ai-avatar">J</div>
                    <span class="ai-text"></span>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            messageCount++;
            updateMessageCount();
            return messageDiv;
        }

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai-message typing';
            typingDiv.innerHTML = `
                <div class="message-content">
                    <div class="ai-avatar">J</div>
                    <div class="typing-indicator"><span></span><span></span><span></span></div>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            scrollToBottom();
            return typingDiv;
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'message ai-message error-message';
            errorDiv.innerHTML = `
                <div class="message-content">
                    <div class="ai-avatar">!</div>
                    <span class="ai-text">${escapeHtml(message)}</span>
                </div>
            `;
            chatMessages.appendChild(errorDiv);
            scrollToBottom();
        }

        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function clearChat() {
            chatMessages.innerHTML = '';
            messageCount = 0;
            userMessageCount = 0;
            yesAndCount = 0;
            blockingCount = 0;
            totalResponseTime = 0;
            lastMessageTime = Date.now();
            updateMetrics();
            updateMessageCount();
        }

        // ============================================
        // SESSION MANAGEMENT
        // ============================================
        
        newSessionBtn.addEventListener('click', () => {
            // Reset everything
            stopTimer();
            timerStarted = false;
            chat = null;
            userGoal = null;
            selectedGoal = null;
            clearChat();
            
            // Reset UI
            goalDisplay.style.display = 'none';
            aiFeedbackSection.classList.remove('visible');
            goalOptions.querySelectorAll('.goal-option').forEach(o => o.classList.remove('selected'));
            customGoalInput.value = '';
            goalSubmitBtn.disabled = true;
            
            // Show goal modal
            goalModal.classList.remove('hidden');
            updateState('GOAL_SELECTION');
        });
        
        howToPlayBtn.addEventListener('click', () => {
            // Restart the teaching flow
            stopTimer();
            timerStarted = false;
            clearChat();
            aiFeedbackSection.classList.remove('visible');
            
            // Reset metrics for new session
            userMessageCount = 0;
            yesAndCount = 0;
            blockingCount = 0;
            totalResponseTime = 0;
            updateMetrics();
            
            if (genAI && userGoal) {
                // Important: Update state BEFORE starting chat
                updateState('TEACHING');
                startChat();
            }
        });

        endSessionBtn.addEventListener('click', () => {
            if (currentState === 'PLAYING' && userMessageCount > 0) {
                updateState('FEEDBACK');
            } else if (currentState !== 'PLAYING') {
                alert('Start a practice session first!');
            } else {
                alert('Have a conversation first!');
            }
        });

        // ============================================
        // FEEDBACK GENERATION
        // ============================================
        
        async function generateFeedback() {
            // Disable input
            chatInput.disabled = true;
            sendBtn.disabled = true;
            micBtn.disabled = true;
            if (isRecording) stopRecording();
            inputPrompt.textContent = 'Session complete - Click "New" to start another';
            
            // Calculate metrics
            const yesAndRate = userMessageCount > 0 ? Math.round((yesAndCount / userMessageCount) * 100) : 0;
            const blockingRate = userMessageCount > 0 ? Math.round((blockingCount / userMessageCount) * 100) : 0;
            const avgTime = userMessageCount > 0 ? Math.round(totalResponseTime / userMessageCount / 1000) : 0;
            
            // Generate AI feedback summary in chat
            const feedbackSummary = generateFeedbackSummary(yesAndRate, blockingRate, avgTime);
            
            const feedbackDiv = document.createElement('div');
            feedbackDiv.className = 'message ai-message';
            feedbackDiv.innerHTML = `
                <div class="message-content">
                    <div class="ai-avatar">J</div>
                    <span class="ai-text">${escapeHtml(feedbackSummary)}</span>
                </div>
            `;
            chatMessages.appendChild(feedbackDiv);
            scrollToBottom();
            
            // Show improvement tips in sidebar
            const tips = generateImprovementTips(yesAndRate, blockingRate, avgTime);
            aiFeedbackContent.innerHTML = tips;
            aiFeedbackSection.classList.add('visible');
        }
        
        function generateFeedbackSummary(yesAndRate, blockingRate, avgTime) {
            let summary = `Great practice session on "${userGoal}"!\n\n`;
            summary += `Your Stats:\n`;
            summary += `• Messages exchanged: ${messageCount}\n`;
            summary += `• "Yes, And" usage: ${yesAndRate}% (${yesAndCount}/${userMessageCount})\n`;
            summary += `• Blocking moments: ${blockingRate}% (${blockingCount}/${userMessageCount})\n`;
            summary += `• Average response time: ${avgTime}s\n\n`;
            
            if (yesAndRate >= 70) {
                summary += `Excellent work! You really embraced the "Yes, and..." mindset.`;
            } else if (yesAndRate >= 50) {
                summary += `Good effort! Keep practicing to build that "Yes, and..." muscle.`;
            } else {
                summary += `Nice start! Remember, the key is accepting ideas before adding to them.`;
            }
            
            return summary;
        }
        
        function generateImprovementTips(yesAndRate, blockingRate, avgTime) {
            let tips = '';
            
            if (yesAndRate < 50) {
                tips += '<p>• Try starting responses with "Yes, and...", "Great idea!", or "I love that!"</p>';
            }
            if (blockingRate > 30) {
                tips += '<p>• When you feel like saying "no", try finding something to agree with first</p>';
            }
            if (avgTime > 10) {
                tips += '<p>• Trust your instincts - improv is about going with your gut!</p>';
            }
            if (yesAndRate >= 70 && blockingRate < 20) {
                tips += '<p>• Fantastic flow! Try more challenging scenarios to push yourself.</p>';
            }
            
            if (!tips) {
                tips = '<p>• Great session! Keep practicing to make "Yes, and..." second nature.</p>';
            }
            
            return tips;
        }

        // ============================================
        // METRICS
        // ============================================
        
        function updateMetrics() {
            yesAndValue.textContent = yesAndCount;
            blockingValue.textContent = blockingCount;
            
            if (userMessageCount > 0) {
                const yesAndRate = Math.round((yesAndCount / userMessageCount) * 100);
                yesAndFill.style.width = yesAndRate + '%';
                
                const blockingRate = Math.round((blockingCount / userMessageCount) * 100);
                blockingFill.style.width = Math.min(blockingRate * 2, 100) + '%';
                
                const avgTime = totalResponseTime / userMessageCount;
                let engagement = avgTime < 5000 ? 95 : avgTime < 10000 ? 80 : avgTime < 15000 ? 65 : 50;
                engagementValue.textContent = engagement + '%';
                engagementFill.style.width = engagement + '%';
            } else {
                yesAndFill.style.width = '0%';
                blockingFill.style.width = '0%';
                engagementValue.textContent = '--';
                engagementFill.style.width = '0%';
            }
        }

        function updateMessageCount() {
            messageCountEl.textContent = messageCount;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================
        // START - Show goal modal on load
        // ============================================
        updateState('GOAL_SELECTION');
    </script>
</body>
</html>
