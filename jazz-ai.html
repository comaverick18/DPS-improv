t p<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JAZZ - AI Practice Partner | improvU</title>
    <meta name="description" content="Practice conversations with your AI coach in a safe, judgment-free environment. Master improvisational skills through real-time feedback.">
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Google Generative AI Import Map -->
    <script type="importmap">
    {
        "imports": {
            "@google/generative-ai": "https://cdn.jsdelivr.net/npm/@google/generative-ai@latest/dist/index.mjs"
        }
    }
    </script>
    
    <style>
        /* ============================================
           LAYOUT OVERRIDES - Full height chat with pinned input
           Using !important to override external styles.css
           ============================================ */
        .jazz-main {
            padding-top: 100px !important;
            min-height: 100vh !important;
            background: linear-gradient(135deg, #F8F9FB 0%, #EEF1F8 100%) !important;
        }
        .jazz-layout {
            height: calc(100vh - 140px) !important;
            display: grid !important;
        }
        .jazz-chat {
            display: flex !important;
            flex-direction: column !important;
            height: 100% !important;
            max-height: 100% !important;
            min-height: 0 !important;
            overflow: hidden !important;
        }
        .chat-messages {
            flex: 1 1 auto !important;
            min-height: 0 !important;
            max-height: none !important;
            overflow-y: auto !important;
            padding: 24px !important;
            scroll-behavior: smooth !important;
            display: flex !important;
            flex-direction: column !important;
            gap: 16px !important;
        }
        .chat-input-area {
            flex: 0 0 auto !important;
            margin-top: auto !important;
            padding: 20px 24px !important;
            background: white !important;
            border-top: 1px solid #E5E8F0 !important;
            border-radius: 0 0 16px 16px !important;
        }
        /* Hide old voice-input class if it exists */
        .voice-input {
            display: none !important;
        }
        /* Suggested responses - part of bottom section */
        .suggested-responses {
            flex: 0 0 auto !important;
            padding: 16px 24px !important;
            background: #F8FAFC !important;
            border-top: 1px dashed #E2E8F0 !important;
        }
        /* Ensure scenario header doesn't grow */
        .scenario-header {
            flex: 0 0 auto !important;
        }

        /* ============================================
           CHAT INPUT STYLING
           ============================================ */
        .chat-input-container {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .chat-input {
            flex: 1;
            padding: 16px 24px;
            border: 2px solid #E5E8F0;
            border-radius: 100px;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            color: #1E2875;
            background: #F8F9FB;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .chat-input:focus {
            outline: none;
            border-color: #4169E1;
            background: #FFFFFF;
            box-shadow: 0 0 0 4px rgba(65, 105, 225, 0.1);
        }
        .chat-input::placeholder {
            color: #9CA3AF;
        }
        .chat-input:disabled {
            background: #F3F4F6;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .send-btn {
            background: linear-gradient(135deg, #4169E1 0%, #5B7FFF 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 100px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 14px rgba(65, 105, 225, 0.35);
        }
        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(65, 105, 225, 0.45);
        }
        .send-btn:disabled {
            background: #CBD5E1;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .send-btn svg {
            width: 18px;
            height: 18px;
        }
        .input-hint {
            text-align: center;
            font-size: 13px;
            color: #9CA3AF;
            margin-top: 10px;
        }
        .input-hint .keyboard-hint {
            color: #6B7280;
            font-weight: 500;
        }

        /* ============================================
           MESSAGE STYLING
           ============================================ */
        .ai-avatar {
            width: 36px;
            height: 36px;
            min-width: 36px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #1E2875;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 15px;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
        }
        .message.ai-message .message-content {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            background: linear-gradient(135deg, #4169E1 0%, #5B7FFF 100%);
            color: white;
            padding: 16px 20px;
            border-radius: 20px 20px 20px 4px;
            box-shadow: 0 4px 12px rgba(65, 105, 225, 0.2);
        }
        .message.ai-message .ai-text {
            flex: 1;
            white-space: pre-wrap;
            line-height: 1.6;
        }
        .message.user-message .message-content {
            background: #F1F5F9;
            color: #1E2875;
            padding: 16px 20px;
            border-radius: 20px 20px 4px 20px;
        }
        
        /* Yes And Badge - user messages need column layout for badge below */
        .message.user-message {
            position: relative;
            flex-direction: column !important;
            align-items: flex-end !important;
        }
        .yes-and-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 5px 12px;
            border-radius: 12px;
            margin-top: 8px;
            animation: badgePop 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }
        @keyframes badgePop {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* Error message styling */
        .message.error-message .message-content {
            background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%) !important;
            color: #991B1B !important;
        }
        .message.error-message .ai-avatar {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            color: white;
        }
        
        /* Typing indicator */
        .message.ai-message.typing .message-content {
            padding: 16px 20px;
        }
        .message.ai-message .typing-indicator {
            display: flex;
            gap: 6px;
            align-items: center;
            padding: 4px 0;
        }
        .message.ai-message .typing-indicator span {
            width: 10px;
            height: 10px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        .message.ai-message .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .message.ai-message .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* ============================================
           SIDEBAR ENHANCEMENTS
           ============================================ */
        .jazz-sidebar {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(30, 40, 117, 0.08);
        }
        .how-to-play-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 14px 20px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #1E2875;
            border: none;
            border-radius: 14px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
        }
        .how-to-play-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 215, 0, 0.4);
        }
        .how-to-play-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Difficulty tags */
        .difficulty-tag {
            display: inline-block;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 4px 10px;
            border-radius: 10px;
            margin-top: 8px;
        }
        .difficulty-tag.beginner {
            background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
            color: #065F46;
        }
        .difficulty-tag.intermediate {
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            color: #92400E;
        }
        .difficulty-tag.advanced {
            background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
            color: #991B1B;
        }

        /* Session items */
        .session-item {
            border-radius: 14px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .session-item:hover {
            background: #F8FAFC;
            border-color: #E2E8F0;
        }
        .session-item.active {
            background: linear-gradient(135deg, #EEF2FF 0%, #E0E7FF 100%);
            border-color: #4169E1;
        }

        /* ============================================
           FEEDBACK PANEL
           ============================================ */
        .jazz-feedback {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(30, 40, 117, 0.08);
        }
        .jazz-feedback h3 {
            font-size: 18px;
            background: linear-gradient(135deg, #1E2875 0%, #4169E1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .metric-label {
            font-size: 11px;
            color: #9CA3AF;
            margin-top: 6px;
        }
        .progress-fill {
            background: linear-gradient(90deg, #4169E1, #10B981) !important;
        }

        /* ============================================
           ONBOARDING MODAL
           ============================================ */
        .onboarding-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(30, 40, 117, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
        }
        .onboarding-modal.hidden { display: none; }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .onboarding-content {
            background: white;
            border-radius: 28px;
            padding: 48px;
            max-width: 560px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 32px 64px rgba(30, 40, 117, 0.4);
            animation: slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes slideUp {
            from { transform: translateY(30px) scale(0.95); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        .onboarding-header {
            text-align: center;
            margin-bottom: 32px;
        }
        .onboarding-header .ai-avatar {
            width: 72px;
            height: 72px;
            font-size: 32px;
            margin: 0 auto 20px;
        }
        .onboarding-header h2 {
            color: #1E2875;
            font-size: 32px;
            margin: 0;
            font-weight: 700;
        }
        .onboarding-body h3 {
            color: #1E2875;
            font-size: 18px;
            margin: 28px 0 14px;
            font-weight: 600;
        }
        .onboarding-body h3:first-child { margin-top: 0; }
        .onboarding-body p {
            color: #6B7280;
            line-height: 1.7;
            margin: 0 0 14px;
            font-size: 15px;
        }
        .onboarding-body ol {
            color: #6B7280;
            padding-left: 24px;
            line-height: 2;
            margin: 0 0 28px;
        }
        .onboarding-body strong { color: #1E2875; }
        
        /* Example boxes */
        .example-box {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 20px 0 28px;
        }
        .example-bad, .example-good {
            padding: 20px;
            border-radius: 16px;
        }
        .example-bad {
            background: linear-gradient(135deg, #FEF2F2 0%, #FEE2E2 100%);
            border: 2px solid #FECACA;
        }
        .example-good {
            background: linear-gradient(135deg, #F0FDF4 0%, #DCFCE7 100%);
            border: 2px solid #BBF7D0;
        }
        .example-box .label {
            font-weight: 700;
            display: block;
            margin-bottom: 14px;
            font-size: 14px;
        }
        .example-box .dialogue {
            margin: 8px 0;
            font-size: 13px;
            color: #374151;
            line-height: 1.5;
        }

        /* Start button */
        .start-btn {
            display: block;
            width: 100%;
            background: linear-gradient(135deg, #4169E1 0%, #5B7FFF 100%);
            color: white;
            font-size: 17px;
            font-weight: 600;
            padding: 18px 36px;
            border-radius: 100px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(65, 105, 225, 0.35);
            margin-top: 8px;
        }
        .start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 28px rgba(65, 105, 225, 0.45);
        }

        /* ============================================
           SUGGESTED RESPONSES
           ============================================ */
        .suggested-responses {
            padding: 16px 24px;
            background: #F8FAFC;
            border-top: 1px dashed #E2E8F0;
        }
        .suggested-responses p {
            font-size: 13px;
            color: #6B7280;
            margin: 0 0 12px 0;
            font-weight: 500;
        }
        .suggestions-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .suggestion-chip {
            background: white;
            border: 2px solid #E2E8F0;
            color: #4169E1;
            font-size: 13px;
            font-weight: 500;
            padding: 10px 18px;
            border-radius: 100px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .suggestion-chip:hover {
            background: #4169E1;
            color: white;
            border-color: #4169E1;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(65, 105, 225, 0.25);
        }

        /* ============================================
           RESPONSIVE
           ============================================ */
        @media (max-width: 768px) {
            .example-box { grid-template-columns: 1fr; }
            .onboarding-content { padding: 28px; }
            .onboarding-header h2 { font-size: 26px; }
        }
    </style>
</head>
<body>
    <!-- ============================================
         ONBOARDING MODAL
         ============================================ -->
    <div class="onboarding-modal" id="onboardingModal">
        <div class="onboarding-content">
            <div class="onboarding-header">
                <div class="ai-avatar">J</div>
                <h2>Welcome to Jazz! üé≠</h2>
            </div>
            
            <div class="onboarding-body">
                <h3>What is "Yes, And..."?</h3>
                <p>It's the <strong>#1 rule of improv!</strong> Instead of blocking ideas, you <strong>accept</strong> what's offered and <strong>build</strong> on it.</p>
                
                <div class="example-box">
                    <div class="example-bad">
                        <span class="label">‚ùå Blocking</span>
                        <p class="dialogue"><strong>Partner:</strong> "Let's go to the moon!"</p>
                        <p class="dialogue"><strong>You:</strong> "That's impossible."</p>
                    </div>
                    <div class="example-good">
                        <span class="label">‚úÖ Yes, And...</span>
                        <p class="dialogue"><strong>Partner:</strong> "Let's go to the moon!"</p>
                        <p class="dialogue"><strong>You:</strong> "Yes! And let's pack snacks for the trip!"</p>
                    </div>
                </div>
                
                <h3>How Jazz Works</h3>
                <ol>
                    <li><strong>Pick a scenario</strong> from the sidebar</li>
                    <li><strong>I'll set the scene</strong> and start our conversation</li>
                    <li><strong>You respond</strong> using "Yes, and..." thinking</li>
                    <li><strong>We build a story together!</strong> No wrong answers üòä</li>
                </ol>
                
                <p style="text-align: center; color: #4169E1; font-weight: 600; font-size: 16px;">
                    The goal isn't perfection ‚Äî it's practice!
                </p>
            </div>
            
            <button class="start-btn" id="startPracticing">
                Got it! Let's Practice üöÄ
            </button>
        </div>
    </div>

    <!-- ============================================
         NAVIGATION (no icon, just text)
         ============================================ -->
    <nav class="nav">
        <div class="container">
            <div class="nav-content">
                <div class="logo">
                    <a href="index.html" class="logo-text">improvU</a>
                </div>
                <div class="nav-links">
                    <a href="jazz-ai.html" class="nav-link active">Jazz</a>
                    <a href="convoquest.html" class="nav-link">ConvoQuest</a>
                    <a href="improvcircle.html" class="nav-link">ImprovCircle</a>
                    <button class="nav-login-btn">Get Started</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- ============================================
         JAZZ MAIN CONTENT
         ============================================ -->
    <section class="jazz-main">
        <div class="container">
            <div class="jazz-layout">
                <!-- Left Sidebar -->
                <div class="jazz-sidebar">
                    <div class="jazz-header">
                        <h1 class="jazz-title">Jazz AI</h1>
                        <button class="new-session-btn" id="newSessionBtn">
                            <svg viewBox="0 0 24 24" fill="none">
                                <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            New
                        </button>
                    </div>

                    <!-- How to Play Button -->
                    <button class="how-to-play-btn" id="howToPlayBtn">
                        <svg viewBox="0 0 24 24" fill="none">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                            <path d="M12 16v-4M12 8h.01" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
                        </svg>
                        How to Play
                    </button>

                    <!-- Topic Selection List -->
                    <div class="session-list" id="topicList">
                        <div class="session-item" data-topic="Coffee Shop Conversation">
                            <h3>Coffee Shop Chat</h3>
                            <p>Casual small talk</p>
                            <span class="difficulty-tag beginner">Beginner</span>
                        </div>
                        <div class="session-item" data-topic="Planning a Trip">
                            <h3>Planning a Trip</h3>
                            <p>Travel conversations</p>
                            <span class="difficulty-tag beginner">Beginner</span>
                        </div>
                        <div class="session-item" data-topic="Networking Event">
                            <h3>Networking Event</h3>
                            <p>Professional mingling</p>
                            <span class="difficulty-tag intermediate">Intermediate</span>
                        </div>
                        <div class="session-item" data-topic="Job Interview Practice">
                            <h3>Job Interview</h3>
                            <p>Build confidence</p>
                            <span class="difficulty-tag intermediate">Intermediate</span>
                        </div>
                        <div class="session-item" data-topic="First Date Scenario">
                            <h3>First Date</h3>
                            <p>Dating skills</p>
                            <span class="difficulty-tag advanced">Advanced</span>
                        </div>
                    </div>

                    <div class="user-profile">
                        <div class="user-avatar">U</div>
                        <div class="user-info">
                            <h4>Guest User</h4>
                            <p>Practice Mode</p>
                        </div>
                    </div>
                </div>

                <!-- Main Chat Area -->
                <div class="jazz-chat">
                    <div class="scenario-header">
                        <span class="scenario-badge" id="scenarioBadge">Select a scenario to begin</span>
                    </div>

                    <div class="chat-messages" id="chatMessages">
                        <!-- Welcome message inserted by JS -->
                    </div>

                    <!-- Suggested Responses -->
                    <div class="suggested-responses" id="suggestedResponses" style="display: none;">
                        <p>üí° Need a starter? Try one:</p>
                        <div class="suggestions-container">
                            <button class="suggestion-chip" data-suggestion="Yes, and we could also...">Yes, and we could also...</button>
                            <button class="suggestion-chip" data-suggestion="That sounds great! What if...">That sounds great! What if...</button>
                            <button class="suggestion-chip" data-suggestion="I love that idea! And...">I love that idea! And...</button>
                        </div>
                    </div>

                    <!-- Text Input Area - PINNED TO BOTTOM -->
                    <div class="chat-input-area">
                        <div class="chat-input-container">
                            <input 
                                type="text" 
                                class="chat-input" 
                                id="chatInput" 
                                placeholder="Type your response here..." 
                                disabled
                                autocomplete="off"
                            >
                            <button class="send-btn" id="sendBtn" disabled>
                                <svg viewBox="0 0 24 24" fill="none">
                                    <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Send
                            </button>
                        </div>
                        <p class="input-hint" id="inputPrompt">
                            Pick a scenario to start chatting
                        </p>
                    </div>
                </div>

                <!-- Right Sidebar - Feedback -->
                <div class="jazz-feedback">
                    <h3>Session Feedback</h3>
                    
                    <div class="feedback-metric">
                        <div class="metric-header">
                            <span>"Yes, And" Usage</span>
                            <span class="metric-value" id="confidenceValue">--</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="confidenceFill" style="width: 0%"></div>
                        </div>
                        <p class="metric-label">How often you build on ideas</p>
                    </div>

                    <div class="feedback-metric">
                        <div class="metric-header">
                            <span>Engagement</span>
                            <span class="metric-value" id="flowValue">--</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="flowFill" style="width: 0%"></div>
                        </div>
                        <p class="metric-label">Response speed & flow</p>
                    </div>

                    <div class="session-settings">
                        <h4>Session Info</h4>
                        <div class="setting-item">
                            <span>Model</span>
                            <span class="setting-value">Gemini 2.5 Flash</span>
                        </div>
                        <div class="setting-item">
                            <span>Mode</span>
                            <span class="setting-value">Streaming</span>
                        </div>
                        <div class="setting-item">
                            <span>Messages</span>
                            <span class="setting-value" id="messageCount">0</span>
                        </div>
                    </div>

                    <button class="end-session-btn" id="endSessionBtn">End & Get Feedback</button>
                </div>
            </div>
        </div>
    </section>

    <!-- ============================================
         MAIN APPLICATION SCRIPT
         ============================================ -->
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // ============================================
        // CONFIGURATION
        // ============================================
        
        async function getApiKey() {
            if (typeof window !== 'undefined' && window.GEMINI_API_KEY) {
                return window.GEMINI_API_KEY;
            }
            const storedKey = localStorage.getItem('gemini_api_key');
            if (storedKey) return storedKey;
            
            const key = prompt(
                'üîë Enter your Gemini API key:\n\n' +
                'Get a free key at:\nhttps://makersuite.google.com/app/apikey\n\n' +
                '(Key will be saved for convenience)'
            );
            if (key && key.trim()) {
                localStorage.setItem('gemini_api_key', key.trim());
                return key.trim();
            }
            return null;
        }

        function getSystemInstruction(topic) {
            return `You are JAZZ, an encouraging improv coach from improvU. You teach 'Yes, and...' principles through conversation practice.

YOUR PERSONALITY:
- Supportive, playful, and judgment-free
- You celebrate every attempt the user makes
- You gently guide them to build on ideas rather than blocking them
- You keep things light and fun
- You're enthusiastic but not overwhelming

CONVERSATION GUIDELINES:
- Keep responses concise (2-3 sentences max)
- Always model "Yes, and..." thinking in your responses
- Build on whatever the user says, never shut down their ideas
- Occasionally acknowledge good "Yes, and" technique when you see it
- If they seem stuck, offer a gentle prompt or question
- Use emoji sparingly to keep things friendly üòä
- Stay in character for the scenario

CURRENT SCENARIO: ${topic}

Begin by briefly setting up the scenario (1-2 sentences) and invite the user to participate.`;
        }

        // ============================================
        // DOM ELEMENTS
        // ============================================
        
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const inputPrompt = document.getElementById('inputPrompt');
        const scenarioBadge = document.getElementById('scenarioBadge');
        const topicList = document.getElementById('topicList');
        const newSessionBtn = document.getElementById('newSessionBtn');
        const endSessionBtn = document.getElementById('endSessionBtn');
        const howToPlayBtn = document.getElementById('howToPlayBtn');
        const onboardingModal = document.getElementById('onboardingModal');
        const startPracticingBtn = document.getElementById('startPracticing');
        const suggestedResponses = document.getElementById('suggestedResponses');
        const confidenceValue = document.getElementById('confidenceValue');
        const confidenceFill = document.getElementById('confidenceFill');
        const flowValue = document.getElementById('flowValue');
        const flowFill = document.getElementById('flowFill');
        const messageCountEl = document.getElementById('messageCount');

        // ============================================
        // STATE
        // ============================================
        
        let genAI = null;
        let chat = null;
        let currentTopic = null;
        let isGenerating = false;
        let messageCount = 0;
        let yesAndCount = 0;
        let userMessageCount = 0;
        let lastMessageTime = Date.now();
        let totalResponseTime = 0;
        let suggestionTimeout = null;

        // ============================================
        // ONBOARDING
        // ============================================
        
        const hasSeenOnboarding = localStorage.getItem('jazz_onboarding_complete');
        if (hasSeenOnboarding) onboardingModal.classList.add('hidden');

        startPracticingBtn.addEventListener('click', () => {
            localStorage.setItem('jazz_onboarding_complete', 'true');
            onboardingModal.classList.add('hidden');
        });

        howToPlayBtn.addEventListener('click', () => {
            onboardingModal.classList.remove('hidden');
        });

        // ============================================
        // INITIALIZATION
        // ============================================
        
        async function init() {
            chatInput.placeholder = "Connecting to Jazz AI...";
            showWelcomeMessage();
            
            const API_KEY = await getApiKey();
            if (!API_KEY) {
                chatInput.placeholder = "API key required";
                showError("API key not configured. Please refresh and enter your key.");
                return;
            }
            
            try {
                genAI = new GoogleGenerativeAI(API_KEY);
                console.log('‚úÖ Gemini AI initialized');
                chatInput.placeholder = "Type your response here...";
            } catch (error) {
                console.error('‚ùå Failed to initialize:', error);
                showError("Failed to connect. Please check your API key.");
            }
        }

        // ============================================
        // TOPIC SELECTION
        // ============================================
        
        topicList.querySelectorAll('.session-item').forEach(item => {
            item.addEventListener('click', () => selectTopic(item));
        });

        async function selectTopic(topicElement) {
            if (!genAI) {
                showError("AI not ready. Please refresh the page.");
                return;
            }
            
            topicList.querySelectorAll('.session-item').forEach(item => {
                item.classList.remove('active');
            });
            topicElement.classList.add('active');
            
            currentTopic = topicElement.dataset.topic;
            scenarioBadge.textContent = `Scenario: ${currentTopic}`;
            
            chatInput.disabled = false;
            sendBtn.disabled = false;
            inputPrompt.innerHTML = 'Type your response <span class="keyboard-hint">(Enter to send)</span>';
            
            clearChat();
            await initializeChat();
        }

        async function initializeChat() {
            try {
                const model = genAI.getGenerativeModel({ 
                    model: "gemini-2.5-flash",
                    systemInstruction: getSystemInstruction(currentTopic)
                });
                
                chat = model.startChat({
                    history: [],
                    generationConfig: {
                        maxOutputTokens: 400,
                        temperature: 0.9,
                    },
                });
                
                await sendToAI("Let's begin!");
                startSuggestionTimer();
            } catch (error) {
                console.error('‚ùå Chat init failed:', error);
                showError("Connection issue. Please try again.");
            }
        }

        // ============================================
        // CHAT FUNCTIONALITY
        // ============================================
        
        sendBtn.addEventListener('click', handleSend);
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        });
        chatInput.addEventListener('input', () => {
            hideSuggestions();
            resetSuggestionTimer();
        });

        async function handleSend() {
            const message = chatInput.value.trim();
            if (!message || isGenerating || !chat) return;
            
            const responseTime = Date.now() - lastMessageTime;
            totalResponseTime += responseTime;
            
            addUserMessage(message);
            chatInput.value = '';
            hideSuggestions();
            
            await sendToAI(message);
            lastMessageTime = Date.now();
            resetSuggestionTimer();
        }

        async function sendToAI(userMessage) {
            if (isGenerating) return;
            
            isGenerating = true;
            sendBtn.disabled = true;
            chatInput.disabled = true;
            
            const typingDiv = showTypingIndicator();
            
            try {
                const result = await chat.sendMessageStream(userMessage);
                typingDiv.remove();
                const aiMessageDiv = createAIMessageElement();
                const textSpan = aiMessageDiv.querySelector('.ai-text');
                
                let fullResponse = '';
                for await (const chunk of result.stream) {
                    fullResponse += chunk.text();
                    textSpan.textContent = fullResponse;
                    scrollToBottom();
                }
                updateMetrics();
            } catch (error) {
                console.error('‚ùå AI error:', error);
                typingDiv.remove();
                showError("Connection issue. Please try again.");
            } finally {
                isGenerating = false;
                sendBtn.disabled = false;
                chatInput.disabled = false;
                chatInput.focus();
            }
        }

        // ============================================
        // SUGGESTIONS
        // ============================================
        
        function startSuggestionTimer() { resetSuggestionTimer(); }
        
        function resetSuggestionTimer() {
            clearTimeout(suggestionTimeout);
            suggestionTimeout = setTimeout(() => {
                if (chat && !isGenerating && userMessageCount > 0) showSuggestions();
            }, 12000);
        }
        
        function showSuggestions() { suggestedResponses.style.display = 'block'; }
        function hideSuggestions() { suggestedResponses.style.display = 'none'; }

        document.querySelectorAll('.suggestion-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                chatInput.value = chip.dataset.suggestion;
                chatInput.focus();
                hideSuggestions();
            });
        });

        // ============================================
        // MESSAGES
        // ============================================
        
        function hasYesAndPattern(text) {
            const patterns = [/yes,?\s+and/i, /absolutely/i, /great idea/i, /love that/i, 
                /that sounds/i, /building on/i, /i like that/i, /perfect/i, /definitely/i,
                /what if we/i, /we could also/i, /let's also/i, /and we/i, /and maybe/i];
            return patterns.some(p => p.test(text));
        }

        function addUserMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user-message';
            
            const usedYesAnd = hasYesAndPattern(text);
            if (usedYesAnd) yesAndCount++;
            userMessageCount++;
            
            messageDiv.innerHTML = `
                <div class="message-content">${escapeHtml(text)}</div>
                ${usedYesAnd ? '<span class="yes-and-badge">‚ú® Nice "Yes, and..."!</span>' : ''}
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
            messageCount++;
            updateMessageCount();
        }

        function createAIMessageElement() {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai-message';
            messageDiv.innerHTML = `
                <div class="message-content">
                    <div class="ai-avatar">J</div>
                    <span class="ai-text"></span>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            messageCount++;
            updateMessageCount();
            return messageDiv;
        }

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai-message typing';
            typingDiv.innerHTML = `
                <div class="message-content">
                    <div class="ai-avatar">J</div>
                    <div class="typing-indicator"><span></span><span></span><span></span></div>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            scrollToBottom();
            return typingDiv;
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'message ai-message error-message';
            errorDiv.innerHTML = `
                <div class="message-content">
                    <div class="ai-avatar">!</div>
                    <span class="ai-text">${escapeHtml(message)}</span>
                </div>
            `;
            chatMessages.appendChild(errorDiv);
            scrollToBottom();
        }

        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function clearChat() {
            chatMessages.innerHTML = '';
            messageCount = 0;
            userMessageCount = 0;
            yesAndCount = 0;
            totalResponseTime = 0;
            lastMessageTime = Date.now();
            updateMetrics();
            updateMessageCount();
            hideSuggestions();
        }

        function showWelcomeMessage() {
            const welcomeDiv = document.createElement('div');
            welcomeDiv.className = 'message ai-message';
            welcomeDiv.innerHTML = `
                <div class="message-content">
                    <div class="ai-avatar">J</div>
                    <span class="ai-text">Hey! üëã I'm Jazz, your improv practice partner.

üé≠ We practice "Yes, and..." here ‚Äî accept ideas and build on them!

Pick a scenario from the sidebar to get started. There are no wrong answers! ‚ú®</span>
                </div>
            `;
            chatMessages.appendChild(welcomeDiv);
        }

        // ============================================
        // SESSION MANAGEMENT
        // ============================================
        
        newSessionBtn.addEventListener('click', () => {
            chat = null;
            currentTopic = null;
            topicList.querySelectorAll('.session-item').forEach(i => i.classList.remove('active'));
            scenarioBadge.textContent = 'Select a scenario to begin';
            chatInput.disabled = true;
            sendBtn.disabled = true;
            inputPrompt.innerHTML = 'Pick a scenario to start chatting';
            clearChat();
            showWelcomeMessage();
            clearTimeout(suggestionTimeout);
        });

        endSessionBtn.addEventListener('click', () => {
            if (messageCount < 2) {
                alert('Have a conversation first!');
                return;
            }
            
            const yesAndRate = userMessageCount > 0 ? Math.round((yesAndCount / userMessageCount) * 100) : 0;
            const avgTime = userMessageCount > 0 ? Math.round(totalResponseTime / userMessageCount / 1000) : 0;
            
            const feedbackMsg = `üéâ Great session practicing "${currentTopic}"!

üìä Your Stats:
‚Ä¢ Messages: ${messageCount}
‚Ä¢ "Yes, And" usage: ${yesAndRate}% (${yesAndCount}/${userMessageCount})
‚Ä¢ Avg response: ${avgTime}s

üí° Tips:
${yesAndRate < 50 ? '‚Ä¢ Try starting with "Yes, and...", "Great idea!", or "I love that!"' : '‚Ä¢ Great "Yes, and" usage! Keep it up!'}
${avgTime > 15 ? '‚Ä¢ Try responding faster ‚Äî improv is about going with your gut!' : '‚Ä¢ Nice quick responses ‚Äî keeps the energy flowing!'}

Click "New" to try another scenario!`;
            
            const feedbackDiv = document.createElement('div');
            feedbackDiv.className = 'message ai-message';
            feedbackDiv.innerHTML = `
                <div class="message-content">
                    <div class="ai-avatar">J</div>
                    <span class="ai-text">${escapeHtml(feedbackMsg)}</span>
                </div>
            `;
            chatMessages.appendChild(feedbackDiv);
            scrollToBottom();
            
            chatInput.disabled = true;
            sendBtn.disabled = true;
            inputPrompt.innerHTML = 'Session ended ‚Äî Click "New" to continue';
            chat = null;
            clearTimeout(suggestionTimeout);
            hideSuggestions();
        });

        // ============================================
        // METRICS
        // ============================================
        
        function updateMetrics() {
            if (userMessageCount > 0) {
                const yesAndRate = Math.round((yesAndCount / userMessageCount) * 100);
                confidenceValue.textContent = yesAndRate + '%';
                confidenceFill.style.width = yesAndRate + '%';
                
                const avgTime = totalResponseTime / userMessageCount;
                let engagement = avgTime < 6000 ? 95 : avgTime < 12000 ? 80 : avgTime < 20000 ? 65 : 50;
                flowValue.textContent = engagement + '%';
                flowFill.style.width = engagement + '%';
            } else {
                confidenceValue.textContent = '--';
                confidenceFill.style.width = '0%';
                flowValue.textContent = '--';
                flowFill.style.width = '0%';
            }
        }

        function updateMessageCount() {
            messageCountEl.textContent = messageCount;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================
        // START
        // ============================================
        init();
    </script>
</body>
</html>
